# 故障排除指南

## 常见错误信息

### 1. "Uncaught (in promise) fetchError: Failed to fetch"
**原因**：浏览器扩展拦截了网络请求  
**表现**：报错出现在 console，但功能仍然完成  
**影响**：无（扩展问题，不是应用问题）  
**解决方案**：
1. 检查是否有浏览器扩展（如代理、广告拦截等）干扰
2. 尝试在无痕模式下运行
3. 临时禁用可疑扩展

### 2. "Failed to fetch image" (console warning)
**原因**：无法加载外部图片 URL  
**表现**：图片生成时某个参考图像加载失败  
**影响**：可能影响质量，但通常仍能生成  
**解决方案**：
1. 检查网络连接
2. 确保所有图片 URL 有效
3. 等待重试

### 3. "API Error: 500" 或 "API Error: 400"
**原因**：API 服务器错误或请求格式错误  
**表现**：特定生成步骤失败  
**影响**：该步骤无法完成  
**解决方案**：
1. 查看 Network 选项卡的详细错误信息
2. 检查 API Key 是否有效
3. 查看 DEBUG_IMAGE_GENERATION.md 进行诊断

### 4. "Connection test failed"
**原因**：无法连接到 AI 服务  
**表现**：设置时测试连接失败  
**影响**：无法使用该 Provider  
**解决方案**：
1. 检查网络连接
2. 验证 API Key 和 Base URL 正确
3. 确认 API 服务可用（访问官网）

## 生成流程中的网络请求

```
Step 1: 生成基础故事板
  ↓ POST → Google/SiliconFlow/OpenAI API
  ✅ 成功 → 返回图片
  ❌ 失败 → 显示错误，可重试

Step 2: 融合角色
  ↓ POST → AI API
  ✅ 成功 → 返回融合后的图片
  ❌ 失败 → 显示错误，可跳过

Step 3: 精修分镜（单个或批量）
  ↓ POST → AI API （单个）
  ↓ POST → AI API （批量 - 返回 Job ID）
    ↓ POLL → 检查批量任务状态
  ✅ 成功 → 返回精修图片
  ❌ 失败 → 显示错误，可重新生成

Step 4: 生成文案
  ↓ POST → AI API
  ✅ 成功 → 返回文案
  ❌ 失败 → 显示错误

Step 5: 生成封面
  ↓ POST → AI API
  ✅ 成功 → 返回封面图片
  ❌ 失败 → 显示错误，可重试
```

## 网络故障排查清单

### 如果某个步骤超时或失败：

1. **打开 DevTools** (F12)
2. **Network 选项卡** → 找到失败的请求（红色）
3. **查看 Response** → 了解具体错误
4. **查看 Headers** → 确认 API Key 已发送

### 常见网络问题及解决方案

| 问题 | 排查步骤 | 解决方案 |
|------|--------|--------|
| CORS 错误 | 检查浏览器 console | 检查 API CORS 配置或使用代理 |
| 超时（>30s） | 查看 Network 选项卡 | 检查网络连接，或尝试更小的图片 |
| 401 Unauthorized | 查看 Response | 检查 API Key 有效性 |
| 429 Too Many Requests | 检查消费量 | 等待，降低生成频率 |
| 503 Service Unavailable | 检查 API 状态页 | 等待服务恢复 |

## 浏览器扩展冲突

如果看到来自 `content_script.js` 的错误：

### 可能的扩展冲突：
- ✅ **代理扩展**（可能拦截请求）
- ✅ **广告拦截器**（可能误杀 API 调用）
- ✅ **隐私保护工具**（可能阻止 Cookie/跨域）
- ✅ **开发者工具**（某些配置可能干扰）

### 调试方法：
1. 打开浏览器隐身模式（无扩展）
2. 重新尝试生成
3. 如果在隐身模式成功，说明是扩展问题

### 解决方案：
1. 禁用可疑扩展
2. 或将网站加入扩展的白名单
3. 更新或卸载过时的扩展

## 性能优化建议

如果生成速度慢或容易出错：

### 1. 减少参考图片数量
```
- 当前：使用所有视频帧作为参考
- 建议：只使用关键帧（首、中、尾）
```

### 2. 使用更快的 AI 模型
```
Google:     gemini-2.5-flash-image       (当前)
            ↓ 更快但可能质量稍低
            gemini-1.5-flash-image

SiliconFlow: FLUX.1-schnell              (当前，已是快速版)
            ↓ 更慢但质量更好
            Pro/FLUX.1-schnell

OpenAI:     dall-e-3                    (当前)
            ↓ 更快但质量稍低
            dall-e-2
```

### 3. 分步骤处理
```
❌ 一次生成所有步骤（容易超时）
✅ 分步骤生成（更稳定）
```

### 4. 启用批量 API（仅 Google）
```
设置 → 使用批量 API
- 成本更低
- 速度更慢但更稳定（异步）
- 适合夜间处理大量任务
```

## 常见场景

### 场景 1: "生成完成，但有 fetchError 报错"
**这是正常的**  
- 主功能成功
- 错误可能来自扩展或日志请求
- 不需要处理

### 场景 2: "某个步骤经常失败"
**检查步骤**：
1. 该步骤使用的模型是否正确？ → 查看 MODEL_AUDIT.md
2. 该步骤的提示词是否合理？ → 查看 strategies.ts
3. API 额度是否充足？ → 检查 Provider 官网

### 场景 3: "批量生成超级慢"
**这是预期的**：
- Google Batch API 是异步的，可能需要 30+ 分钟
- 成本更低（便宜 50%）
- 可点击"刷新任务状态"查看进度

### 场景 4: "生成图片质量很差"
**尝试**：
1. 检查输入图片质量（原视频清晰度）
2. 修改自定义提示词
3. 切换到质量更好的模型（但会更贵/更慢）

## 需要帮助？

### 快速诊断：
1. 打开 F12 DevTools
2. 复制 Network 失败请求的完整 Response
3. 查看本文档中的对应错误码

### 详细文档：
- `DEBUG_IMAGE_GENERATION.md` - 图像生成特定问题
- `MODEL_AUDIT.md` - 模型配置验证
- `EDGEONE_ENV_CONFIG.md` - 环境配置指南

### 报告 Bug：
在 GitHub Issues 中包含：
1. 错误信息（完整的 console 输出）
2. Network 选项卡的失败请求
3. 当前配置（Provider、模型）
4. 重现步骤
